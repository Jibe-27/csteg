<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Filter & Export</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .table-container { max-height: 500px; overflow: auto; scrollbar-width: thin; scrollbar-color: #667eea #f1f1f1; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
        thead { position: sticky; top: 0; z-index: 10; }
        .loader { border-top-color: #667eea; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: transform 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; transition: all 0.2s; }
        .btn-secondary:hover { background: #667eea; color: white; }
        .upload-zone { border: 3px dashed #cbd5e0; transition: all 0.3s; }
        .upload-zone.drag-over { border-color: #667eea; background: rgba(102, 126, 234, 0.1); }
        .filter-item { background: white; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .filter-item:hover { border-color: #667eea; }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-5xl font-bold text-white mb-2 drop-shadow-lg">üìä Spreadsheet Pro</h1>
            <p class="text-white text-opacity-90">Filtrage avanc√© avec op√©rateurs SQL-like (%, AND, OR)</p>
        </div>

        <!-- Upload -->
        <div class="glass rounded-2xl shadow-2xl p-8 mb-6 fade-in">
            <label class="block text-lg font-semibold text-gray-800 mb-3">üìÅ Charger un fichier</label>
            <div id="uploadZone" class="upload-zone rounded-xl p-8 text-center cursor-pointer">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg font-semibold text-gray-700">Glissez un fichier ici ou cliquez pour parcourir</p>
                <p class="text-sm text-gray-500 mt-2">CSV, XLSX, XLS ¬∑ Jusqu'√† 1M+ lignes</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden"/>
            </div>
            
            <!-- CSV Options -->
            <div id="csvOptions" class="mt-6 hidden">
                <label class="block text-sm font-semibold text-gray-700 mb-3">‚öôÔ∏è S√©parateur CSV</label>
                <div class="grid grid-cols-4 gap-3">
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value="auto">Auto</button>
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value=",">Virgule (,)</button>
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value=";">Point-virgule (;)</button>
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value="\t">Tabulation</button>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div id="progress" class="hidden glass rounded-2xl shadow-xl p-6 mb-6 fade-in">
            <div class="flex items-center">
                <div class="loader border-4 border-gray-200 rounded-full w-8 h-8 mr-4"></div>
                <div>
                    <div class="font-semibold text-gray-800" id="progressText">Chargement...</div>
                    <div class="text-sm text-gray-500">Veuillez patienter</div>
                </div>
            </div>
        </div>

        <!-- Stats & Actions -->
        <div id="statsSection" class="hidden fade-in">
            <!-- Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Total</div>
                    <div class="text-3xl font-bold text-purple-600" id="totalRows">0</div>
                </div>
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Filtr√©es</div>
                    <div class="text-3xl font-bold text-purple-600" id="filteredRows">0</div>
                </div>
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Colonnes</div>
                    <div class="text-3xl font-bold text-purple-600" id="columnCount">0</div>
                </div>
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Aper√ßu</div>
                    <div class="text-3xl font-bold text-purple-600" id="previewRows">0</div>
                </div>
            </div>

            <!-- Global Filters -->
            <div class="glass rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <label class="text-sm font-semibold text-gray-700">üîç Filtres globaux</label>
                    <div class="flex gap-2">
                        <select id="globalOperator" class="px-3 py-1 border-2 border-purple-500 rounded-lg text-sm font-semibold">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                        <button id="addGlobalFilter" class="btn-primary px-4 py-1 rounded-lg text-sm font-semibold">+ Ajouter</button>
                    </div>
                </div>
                <div id="globalFilters" class="space-y-3"></div>
                <div class="text-xs text-gray-500 mt-3">
                    üí° Astuce : Utilisez <code class="bg-gray-100 px-1 rounded">%</code> comme joker (ex: <code class="bg-gray-100 px-1 rounded">Jean%</code> ou <code class="bg-gray-100 px-1 rounded">%2024%</code>)
                </div>
            </div>

            <!-- Column Filters -->
            <div class="glass rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <label class="text-sm font-semibold text-gray-700">üéØ Filtres par colonne</label>
                    <button id="clearColumnFilters" class="text-sm text-purple-600 hover:text-purple-800 font-medium">Effacer tout</button>
                </div>
                <div id="columnFiltersContainer"></div>
            </div>

            <!-- Export Buttons -->
            <div class="glass rounded-2xl shadow-xl p-6 mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">üíæ Exporter les donn√©es filtr√©es</label>
                <div class="flex gap-4">
                    <button id="exportCSV" class="btn-primary flex-1 py-3 px-6 rounded-xl font-semibold shadow-lg">
                        üìÑ Exporter en CSV
                    </button>
                    <button id="exportXLSX" class="btn-secondary flex-1 py-3 px-6 rounded-xl font-semibold shadow-lg">
                        üìó Exporter en XLSX
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Preview -->
        <div id="tableSection" class="hidden glass rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="p-4 bg-gradient-to-r from-purple-600 to-indigo-600">
                <h3 class="text-white font-semibold">üìã Aper√ßu (premi√®res lignes)</h3>
            </div>
            <div class="table-container">
                <table id="dataTable" class="min-w-full">
                    <thead class="bg-gray-100"></thead>
                    <tbody class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let headers = [];
        let globalFilters = [];
        let columnFilters = {};
        let selectedDelimiter = 'auto';
        const PREVIEW_LIMIT = 500;

        const els = {
            uploadZone: document.getElementById('uploadZone'),
            file: document.getElementById('fileInput'),
            csvOptions: document.getElementById('csvOptions'),
            progress: document.getElementById('progress'),
            progressText: document.getElementById('progressText'),
            statsSection: document.getElementById('statsSection'),
            tableSection: document.getElementById('tableSection'),
            globalFilters: document.getElementById('globalFilters'),
            globalOperator: document.getElementById('globalOperator'),
            addGlobalFilter: document.getElementById('addGlobalFilter'),
            columnFiltersContainer: document.getElementById('columnFiltersContainer'),
            clearColumnFilters: document.getElementById('clearColumnFilters'),
            exportCSV: document.getElementById('exportCSV'),
            exportXLSX: document.getElementById('exportXLSX'),
            thead: document.querySelector('#dataTable thead'),
            tbody: document.querySelector('#dataTable tbody'),
            totalRows: document.getElementById('totalRows'),
            filteredRows: document.getElementById('filteredRows'),
            columnCount: document.getElementById('columnCount'),
            previewRows: document.getElementById('previewRows')
        };

        // Drag & Drop
        els.uploadZone.addEventListener('click', () => els.file.click());
        els.uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            els.uploadZone.classList.add('drag-over');
        });
        els.uploadZone.addEventListener('dragleave', () => {
            els.uploadZone.classList.remove('drag-over');
        });
        els.uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            els.uploadZone.classList.remove('drag-over');
            els.file.files = e.dataTransfer.files;
            handleFile();
        });

        // Event listeners
        els.file.addEventListener('change', handleFile);
        els.addGlobalFilter.addEventListener('click', addGlobalFilter);
        els.globalOperator.addEventListener('change', applyFilters);
        els.clearColumnFilters.addEventListener('click', clearColumnFilters);
        els.exportCSV.addEventListener('click', () => exportData('csv'));
        els.exportXLSX.addEventListener('click', () => exportData('xlsx'));

        // Delimiter selection
        document.querySelectorAll('.delimiter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.delimiter-btn').forEach(b => {
                    b.className = 'delimiter-btn py-2 px-4 rounded-lg border-2 border-gray-300 font-medium transition hover:border-purple-500';
                });
                this.className = 'delimiter-btn py-2 px-4 rounded-lg border-2 border-purple-500 bg-purple-50 font-medium transition';
                selectedDelimiter = this.dataset.value;
                if (els.file.files[0]) handleFile();
            });
        });
        document.querySelector('[data-value="auto"]').click();

        function handleFile() {
            const file = els.file.files[0];
            if (!file) return;

            const ext = file.name.split('.').pop().toLowerCase();
            showProgress('Chargement...');
            allData = [];
            headers = [];
            globalFilters = [];
            columnFilters = {};

            if (ext === 'csv') {
                els.csvOptions.classList.remove('hidden');
                parseCSV(file);
            } else {
                els.csvOptions.classList.add('hidden');
                parseExcel(file);
            }
        }

        function parseCSV(file) {
            const delim = selectedDelimiter === 'auto' ? '' : selectedDelimiter;
            
            Papa.parse(file, {
                delimiter: delim,
                header: true,
                skipEmptyLines: true,
                worker: true,
                chunk: (results) => {
                    allData.push(...results.data);
                    els.progressText.textContent = `Charg√©: ${allData.length.toLocaleString()} lignes`;
                },
                complete: () => {
                    if (allData.length > 0) {
                        headers = Object.keys(allData[0]);
                        finishLoading();
                    }
                }
            });
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                allData = XLSX.utils.sheet_to_json(ws);
                
                if (allData.length > 0) {
                    headers = Object.keys(allData[0]);
                    finishLoading();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function finishLoading() {
            hideProgress();
            filteredData = allData;
            createColumnFiltersUI();
            updateStats();
            renderTable();
            els.statsSection.classList.remove('hidden');
            els.tableSection.classList.remove('hidden');
        }

        function addGlobalFilter() {
            const id = Date.now();
            globalFilters.push({ id, column: headers[0], value: '' });
            renderGlobalFilters();
        }

        function renderGlobalFilters() {
            els.globalFilters.innerHTML = globalFilters.map((f, idx) => `
                <div class="filter-item rounded-lg p-4">
                    <div class="flex gap-3 items-center">
                        <span class="text-sm font-semibold text-purple-600">${idx > 0 ? els.globalOperator.value : ''}</span>
                        <select class="flex-1 px-3 py-2 border rounded-lg" onchange="updateGlobalFilter(${f.id}, 'column', this.value)">
                            ${headers.map(h => `<option value="${h}" ${f.column === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                        <input type="text" 
                               value="${f.value}"
                               placeholder="Valeur (utilisez % comme joker)"
                               class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500"
                               oninput="updateGlobalFilter(${f.id}, 'value', this.value)"/>
                        <button onclick="removeGlobalFilter(${f.id})" class="text-red-500 hover:text-red-700 font-bold">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function updateGlobalFilter(id, field, value) {
            const filter = globalFilters.find(f => f.id === id);
            if (filter) {
                filter[field] = value;
                debounceApply();
            }
        }

        function removeGlobalFilter(id) {
            globalFilters = globalFilters.filter(f => f.id !== id);
            renderGlobalFilters();
            applyFilters();
        }

        function createColumnFiltersUI() {
            const columnFiltersList = {};
            headers.forEach(h => columnFiltersList[h] = []);

            const renderColumn = (col) => {
                const filters = columnFiltersList[col];
                const colDiv = document.getElementById(`col-${col}`);
                if (!colDiv) return;

                const filtersHTML = filters.map((f, idx) => `
                    <div class="flex gap-2 items-center mt-2">
                        <span class="text-xs text-purple-600 font-semibold w-8">${idx > 0 ? 'OR' : ''}</span>
                        <input type="text" 
                               value="${f}"
                               placeholder="% = joker"
                               class="flex-1 px-2 py-1 text-sm border rounded focus:outline-none focus:border-purple-500"
                               oninput="updateColumnFilter('${col}', ${idx}, this.value)"/>
                        <button onclick="removeColumnFilter('${col}', ${idx})" class="text-red-500 hover:text-red-700 text-xs font-bold">‚úï</button>
                    </div>
                `).join('');

                colDiv.querySelector('.column-filters-list').innerHTML = filtersHTML;
            };

            els.columnFiltersContainer.innerHTML = headers.map(h => `
                <div id="col-${h}" class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-semibold text-gray-700">${h}</label>
                        <button onclick="addColumnFilter('${h}')" class="text-xs text-purple-600 hover:text-purple-800 font-semibold">+ OR</button>
                    </div>
                    <div class="column-filters-list"></div>
                </div>
            `).join('');

            window.addColumnFilter = (col) => {
                columnFiltersList[col].push('');
                columnFilters[col] = columnFiltersList[col];
                renderColumn(col);
            };

            window.updateColumnFilter = (col, idx, value) => {
                columnFiltersList[col][idx] = value;
                columnFilters[col] = columnFiltersList[col].filter(v => v.trim());
                debounceApply();
            };

            window.removeColumnFilter = (col, idx) => {
                columnFiltersList[col].splice(idx, 1);
                columnFilters[col] = columnFiltersList[col].filter(v => v.trim());
                renderColumn(col);
                applyFilters();
            };
        }

        function clearColumnFilters() {
            columnFilters = {};
            createColumnFiltersUI();
            applyFilters();
        }

        function matchPattern(value, pattern) {
            if (!pattern) return true;
            const val = String(value || '').toLowerCase();
            const pat = pattern.toLowerCase().replace(/%/g, '.*');
            return new RegExp(`^${pat}$`).test(val);
        }

        function applyFilters() {
            const operator = els.globalOperator.value;

            filteredData = allData.filter(row => {
                // Global filters
                if (globalFilters.length > 0) {
                    const results = globalFilters.map(f => matchPattern(row[f.column], f.value));
                    const match = operator === 'AND' ? results.every(r => r) : results.some(r => r);
                    if (!match) return false;
                }

                // Column filters (OR within column)
                for (let col in columnFilters) {
                    if (columnFilters[col].length > 0) {
                        const match = columnFilters[col].some(pattern => matchPattern(row[col], pattern));
                        if (!match) return false;
                    }
                }

                return true;
            });

            updateStats();
            renderTable();
        }

        const debounceApply = debounce(applyFilters, 300);

        function renderTable() {
            els.thead.innerHTML = `<tr>${headers.map(h => 
                `<th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100">${h}</th>`
            ).join('')}</tr>`;

            const preview = filteredData.slice(0, PREVIEW_LIMIT);
            els.tbody.innerHTML = preview.map(row => `
                <tr class="hover:bg-purple-50 transition-colors">
                    ${headers.map(h => `<td class="px-6 py-3 text-sm text-gray-800">${row[h] ?? ''}</td>`).join('')}
                </tr>
            `).join('');
        }

        function updateStats() {
            els.totalRows.textContent = allData.length.toLocaleString();
            els.filteredRows.textContent = filteredData.length.toLocaleString();
            els.columnCount.textContent = headers.length;
            els.previewRows.textContent = Math.min(filteredData.length, PREVIEW_LIMIT).toLocaleString();
        }

        function exportData(format) {
            if (filteredData.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }

            const filename = `export_${new Date().toISOString().slice(0,10)}`;

            if (format === 'csv') {
                const csv = Papa.unparse(filteredData);
                downloadFile(csv, `${filename}.csv`, 'text/csv');
            } else {
                const ws = XLSX.utils.json_to_sheet(filteredData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Export');
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showProgress(text) {
            els.progressText.textContent = text;
            els.progress.classList.remove('hidden');
        }

        function hideProgress() {
            els.progress.classList.add('hidden');
        }

        function debounce(fn, delay) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }
    </script>
</body>
</html>