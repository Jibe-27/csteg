<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Filter & Export</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .table-container { max-height: 500px; overflow: auto; scrollbar-width: thin; scrollbar-color: #667eea #f1f1f1; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
        thead { position: sticky; top: 0; z-index: 10; }
        .loader { border-top-color: #667eea; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: transform 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; transition: all 0.2s; }
        .btn-secondary:hover { background: #667eea; color: white; }
        .column-filter { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-5xl font-bold text-white mb-2 drop-shadow-lg">üìä Spreadsheet Pro</h1>
            <p class="text-white text-opacity-90">Filtrez et exportez vos donn√©es en un clin d'≈ìil</p>
        </div>

        <!-- Upload -->
        <div class="glass rounded-2xl shadow-2xl p-8 mb-6 fade-in">
            <label class="block text-lg font-semibold text-gray-800 mb-3">üìÅ Charger un fichier</label>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" 
                   class="block w-full text-sm file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 file:cursor-pointer"/>
            
            <!-- CSV Options -->
            <div id="csvOptions" class="mt-6 hidden">
                <label class="block text-sm font-semibold text-gray-700 mb-3">‚öôÔ∏è S√©parateur CSV</label>
                <div class="grid grid-cols-4 gap-3">
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value="auto">Auto</button>
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value=",">Virgule (,)</button>
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value=";">Point-virgule (;)</button>
                    <button class="delimiter-btn py-2 px-4 rounded-lg border-2 font-medium transition" data-value="\t">Tabulation</button>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div id="progress" class="hidden glass rounded-2xl shadow-xl p-6 mb-6 fade-in">
            <div class="flex items-center">
                <div class="loader border-4 border-gray-200 rounded-full w-8 h-8 mr-4"></div>
                <div>
                    <div class="font-semibold text-gray-800" id="progressText">Chargement...</div>
                    <div class="text-sm text-gray-500">Veuillez patienter</div>
                </div>
            </div>
        </div>

        <!-- Stats & Actions -->
        <div id="statsSection" class="hidden fade-in">
            <!-- Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Total</div>
                    <div class="text-3xl font-bold text-purple-600" id="totalRows">0</div>
                </div>
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Filtr√©es</div>
                    <div class="text-3xl font-bold text-purple-600" id="filteredRows">0</div>
                </div>
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Colonnes</div>
                    <div class="text-3xl font-bold text-purple-600" id="columnCount">0</div>
                </div>
                <div class="glass rounded-xl shadow-lg p-6 text-center">
                    <div class="text-sm text-gray-600 mb-1">Aper√ßu</div>
                    <div class="text-3xl font-bold text-purple-600" id="previewRows">0</div>
                </div>
            </div>

            <!-- Global Filter -->
            <div class="glass rounded-2xl shadow-xl p-6 mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">üîç Recherche globale</label>
                <input type="text" id="globalFilter" placeholder="Rechercher dans toutes les colonnes..." 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 transition"/>
            </div>

            <!-- Column Filters -->
            <div class="glass rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <label class="text-sm font-semibold text-gray-700">üéØ Filtres par colonne</label>
                    <button id="clearFilters" class="text-sm text-purple-600 hover:text-purple-800 font-medium">Effacer tout</button>
                </div>
                <div id="columnFilters" class="grid grid-cols-3 gap-3"></div>
            </div>

            <!-- Export Buttons -->
            <div class="glass rounded-2xl shadow-xl p-6 mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">üíæ Exporter les donn√©es filtr√©es</label>
                <div class="flex gap-4">
                    <button id="exportCSV" class="btn-primary flex-1 py-3 px-6 rounded-xl font-semibold shadow-lg">
                        üìÑ Exporter en CSV
                    </button>
                    <button id="exportXLSX" class="btn-secondary flex-1 py-3 px-6 rounded-xl font-semibold shadow-lg">
                        üìó Exporter en XLSX
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Preview -->
        <div id="tableSection" class="hidden glass rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="p-4 bg-gradient-to-r from-purple-600 to-indigo-600">
                <h3 class="text-white font-semibold">üìã Aper√ßu (premi√®res lignes)</h3>
            </div>
            <div class="table-container">
                <table id="dataTable" class="min-w-full">
                    <thead class="bg-gray-100"></thead>
                    <tbody class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let headers = [];
        let columnFilters = {};
        let selectedDelimiter = 'auto';
        const PREVIEW_LIMIT = 500; // Max lignes affich√©es

        const els = {
            file: document.getElementById('fileInput'),
            csvOptions: document.getElementById('csvOptions'),
            progress: document.getElementById('progress'),
            progressText: document.getElementById('progressText'),
            statsSection: document.getElementById('statsSection'),
            tableSection: document.getElementById('tableSection'),
            globalFilter: document.getElementById('globalFilter'),
            columnFilters: document.getElementById('columnFilters'),
            clearFilters: document.getElementById('clearFilters'),
            exportCSV: document.getElementById('exportCSV'),
            exportXLSX: document.getElementById('exportXLSX'),
            thead: document.querySelector('#dataTable thead'),
            tbody: document.querySelector('#dataTable tbody'),
            totalRows: document.getElementById('totalRows'),
            filteredRows: document.getElementById('filteredRows'),
            columnCount: document.getElementById('columnCount'),
            previewRows: document.getElementById('previewRows')
        };

        // Event listeners
        els.file.addEventListener('change', handleFile);
        els.globalFilter.addEventListener('input', debounce(applyFilters, 300));
        els.clearFilters.addEventListener('click', clearAllFilters);
        els.exportCSV.addEventListener('click', () => exportData('csv'));
        els.exportXLSX.addEventListener('click', () => exportData('xlsx'));

        // Delimiter selection
        document.querySelectorAll('.delimiter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.delimiter-btn').forEach(b => {
                    b.className = 'delimiter-btn py-2 px-4 rounded-lg border-2 border-gray-300 font-medium transition hover:border-purple-500';
                });
                this.className = 'delimiter-btn py-2 px-4 rounded-lg border-2 border-purple-500 bg-purple-50 font-medium transition';
                selectedDelimiter = this.dataset.value;
                if (els.file.files[0]) handleFile();
            });
        });
        document.querySelector('[data-value="auto"]').click();

        function handleFile() {
            const file = els.file.files[0];
            if (!file) return;

            const ext = file.name.split('.').pop().toLowerCase();
            showProgress('Chargement...');
            allData = [];
            headers = [];
            columnFilters = {};

            if (ext === 'csv') {
                els.csvOptions.classList.remove('hidden');
                parseCSV(file);
            } else {
                els.csvOptions.classList.add('hidden');
                parseExcel(file);
            }
        }

        function parseCSV(file) {
            const delim = selectedDelimiter === 'auto' ? '' : selectedDelimiter;
            
            Papa.parse(file, {
                delimiter: delim,
                header: true,
                skipEmptyLines: true,
                worker: true,
                chunk: (results) => {
                    allData.push(...results.data);
                    els.progressText.textContent = `Charg√©: ${allData.length.toLocaleString()} lignes`;
                },
                complete: () => {
                    if (allData.length > 0) {
                        headers = Object.keys(allData[0]);
                        finishLoading();
                    }
                }
            });
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                allData = XLSX.utils.sheet_to_json(ws);
                
                if (allData.length > 0) {
                    headers = Object.keys(allData[0]);
                    finishLoading();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function finishLoading() {
            hideProgress();
            filteredData = allData;
            createColumnFilters();
            updateStats();
            renderTable();
            els.statsSection.classList.remove('hidden');
            els.tableSection.classList.remove('hidden');
        }

        function createColumnFilters() {
            els.columnFilters.innerHTML = headers.map(h => `
                <div>
                    <label class="text-xs text-gray-600 mb-1 block">${h}</label>
                    <input type="text" 
                           class="column-filter w-full px-2 py-1 border rounded focus:outline-none focus:border-purple-500" 
                           placeholder="Filtrer..."
                           data-column="${h}"/>
                </div>
            `).join('');

            document.querySelectorAll('.column-filter').forEach(input => {
                input.addEventListener('input', debounce(() => {
                    columnFilters[input.dataset.column] = input.value.toLowerCase().trim();
                    applyFilters();
                }, 300));
            });
        }

        function applyFilters() {
            const globalTerm = els.globalFilter.value.toLowerCase().trim();
            
            filteredData = allData.filter(row => {
                // Global filter
                if (globalTerm) {
                    const match = headers.some(h => 
                        (row[h] ?? '').toString().toLowerCase().includes(globalTerm)
                    );
                    if (!match) return false;
                }

                // Column filters
                for (let col in columnFilters) {
                    if (columnFilters[col]) {
                        const val = (row[col] ?? '').toString().toLowerCase();
                        if (!val.includes(columnFilters[col])) return false;
                    }
                }

                return true;
            });

            updateStats();
            renderTable();
        }

        function renderTable() {
            // Headers
            els.thead.innerHTML = `<tr>${headers.map(h => 
                `<th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100">${h}</th>`
            ).join('')}</tr>`;

            // Preview rows (limited)
            const preview = filteredData.slice(0, PREVIEW_LIMIT);
            els.tbody.innerHTML = preview.map(row => `
                <tr class="hover:bg-purple-50 transition-colors">
                    ${headers.map(h => `<td class="px-6 py-3 text-sm text-gray-800">${row[h] ?? ''}</td>`).join('')}
                </tr>
            `).join('');
        }

        function updateStats() {
            els.totalRows.textContent = allData.length.toLocaleString();
            els.filteredRows.textContent = filteredData.length.toLocaleString();
            els.columnCount.textContent = headers.length;
            els.previewRows.textContent = Math.min(filteredData.length, PREVIEW_LIMIT).toLocaleString();
        }

        function clearAllFilters() {
            els.globalFilter.value = '';
            document.querySelectorAll('.column-filter').forEach(input => input.value = '');
            columnFilters = {};
            applyFilters();
        }

        function exportData(format) {
            if (filteredData.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }

            const filename = `export_${new Date().toISOString().slice(0,10)}`;

            if (format === 'csv') {
                const csv = Papa.unparse(filteredData);
                downloadFile(csv, `${filename}.csv`, 'text/csv');
            } else {
                const ws = XLSX.utils.json_to_sheet(filteredData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Export');
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showProgress(text) {
            els.progressText.textContent = text;
            els.progress.classList.remove('hidden');
        }

        function hideProgress() {
            els.progress.classList.add('hidden');
        }

        function debounce(fn, delay) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }
    </script>
</body>
</html>