<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtreur de Fichiers Tableur</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <h1 class="text-4xl font-bold text-slate-800 mb-2">üìä Filtreur de Fichiers Tableur</h1>
            <p class="text-slate-600">Chargez, filtrez et exportez des fichiers CSV/Excel jusqu'√† 1M+ lignes</p>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 mb-2">Fichier</label>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" 
                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
            </div>
            
            <div id="csvOptions" class="hidden mb-4">
                <label class="block text-sm font-semibold text-slate-700 mb-2">S√©parateur CSV</label>
                <select id="delimiter" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="auto">Auto-d√©tection</option>
                    <option value=";">Point-virgule (;)</option>
                    <option value=",">Virgule (,)</option>
                    <option value="\t">Tabulation</option>
                </select>
            </div>

            <div id="progress" class="hidden mb-4">
                <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-slate-600 mt-2 text-center"></p>
            </div>
        </div>

        <!-- Filters Section -->
        <div id="filtersSection" class="hidden bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800">üîç Filtres</h2>
                <div class="flex gap-2">
                    <select id="filterLogic" class="px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                        <option value="AND">ET (AND)</option>
                        <option value="OR">OU (OR)</option>
                    </select>
                    <button onclick="addFilter()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold text-sm">
                        + Ajouter un filtre
                    </button>
                </div>
            </div>
            
            <div id="filtersList" class="space-y-3"></div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="applyFilters()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold shadow-lg">
                    Appliquer les filtres
                </button>
                <button onclick="clearFilters()" class="px-6 py-3 bg-slate-400 text-white rounded-lg hover:bg-slate-500 transition font-semibold">
                    R√©initialiser
                </button>
            </div>
            
            <div id="filterStats" class="mt-4 text-sm text-slate-600"></div>
        </div>

        <!-- Table Section -->
        <div id="tableSection" class="hidden bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800">üìã Aper√ßu des donn√©es</h2>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition font-semibold text-sm shadow">
                        üì• Export CSV
                    </button>
                    <button onclick="exportXLSX()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition font-semibold text-sm shadow">
                        üì• Export XLSX
                    </button>
                </div>
            </div>
            
            <div class="overflow-auto max-h-[600px] border border-slate-200 rounded-lg">
                <table id="dataTable" class="min-w-full divide-y divide-slate-200">
                    <thead id="tableHead" class="bg-slate-50 sticky top-0"></thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let headers = [];
        let columnOrder = [];
        let filters = [];
        const MAX_DISPLAY_ROWS = 500;
        let filterIdCounter = 0;
        let sortableInstance = null;

        // File input handler
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('delimiter').addEventListener('change', () => {
            const file = document.getElementById('fileInput').files[0];
            if (file && file.name.endsWith('.csv')) handleFileSelect();
        });

        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const ext = file.name.split('.').pop().toLowerCase();
            
            if (ext === 'csv') {
                document.getElementById('csvOptions').classList.remove('hidden');
                parseCSV(file);
            } else if (ext === 'xlsx' || ext === 'xls') {
                document.getElementById('csvOptions').classList.add('hidden');
                parseExcel(file);
            }
        }

        function parseCSV(file) {
            showProgress(true);
            const delimiter = document.getElementById('delimiter').value;
            const config = {
                delimiter: delimiter === 'auto' ? '' : delimiter,
                header: true,
                dynamicTyping: false,
                skipEmptyLines: true,
                worker: true,
                chunk: (results, parser) => {
                    allData.push(...results.data);
                    updateProgress(file.size > 0 ? (allData.length * 100) / 100000 : 50);
                },
                complete: () => {
                    finishLoading();
                },
                error: (err) => {
                    alert('Erreur lors du parsing CSV: ' + err.message);
                    showProgress(false);
                }
            };
            
            Papa.parse(file, config);
        }

        function parseExcel(file) {
            showProgress(true);
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    updateProgress(50);
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    allData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                    updateProgress(100);
                    finishLoading();
                } catch (err) {
                    alert('Erreur lors du parsing Excel: ' + err.message);
                    showProgress(false);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function finishLoading() {
            if (allData.length > 0) {
                headers = Object.keys(allData[0]);
                columnOrder = [...headers];
                filteredData = [...allData];
                initializeFilters();
                renderTable();
                updateFilterStats();
                document.getElementById('filtersSection').classList.remove('hidden');
                document.getElementById('tableSection').classList.remove('hidden');
            }
            showProgress(false);
        }

        function showProgress(show) {
            document.getElementById('progress').classList.toggle('hidden', !show);
            if (!show) updateProgress(0);
        }

        function updateProgress(percent) {
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const clamped = Math.min(100, Math.max(0, percent));
            bar.style.width = clamped + '%';
            text.textContent = `Chargement: ${Math.round(clamped)}%`;
        }

        function initializeFilters() {
            filters = [];
            filterIdCounter = 0;
            document.getElementById('filtersList').innerHTML = '';
            addFilter();
        }

        function addFilter(column = '', value = '') {
            const filterId = filterIdCounter++;
            const filterDiv = document.createElement('div');
            filterDiv.className = 'flex gap-2 items-center bg-slate-50 p-3 rounded-lg';
            filterDiv.id = `filter-${filterId}`;
            
            filterDiv.innerHTML = `
                <select class="px-3 py-2 border border-slate-300 rounded-lg text-sm flex-1 focus:ring-2 focus:ring-blue-500" data-filter-id="${filterId}" data-type="column">
                    <option value="">Recherche globale</option>
                    ${headers.map(h => `<option value="${h}" ${h === column ? 'selected' : ''}>${h}</option>`).join('')}
                </select>
                <input type="text" placeholder="Valeur (utilisez %% comme joker)" value="${value}"
                    class="px-3 py-2 border border-slate-300 rounded-lg text-sm flex-1 focus:ring-2 focus:ring-blue-500" 
                    data-filter-id="${filterId}" data-type="value">
                <button onclick="removeFilter(${filterId})" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-semibold">
                    ‚úï
                </button>
            `;
            
            document.getElementById('filtersList').appendChild(filterDiv);
            
            filters.push({ id: filterId, column: column, value: value });
        }

        function removeFilter(filterId) {
            const filterDiv = document.getElementById(`filter-${filterId}`);
            if (filterDiv) filterDiv.remove();
            filters = filters.filter(f => f.id !== filterId);
            if (filters.length === 0) addFilter();
        }

        function getFilterValues() {
            const result = [];
            filters.forEach(f => {
                const columnSelect = document.querySelector(`select[data-filter-id="${f.id}"]`);
                const valueInput = document.querySelector(`input[data-filter-id="${f.id}"]`);
                if (columnSelect && valueInput) {
                    const column = columnSelect.value;
                    const value = valueInput.value.trim();
                    if (value) {
                        result.push({ column, value });
                    }
                }
            });
            return result;
        }

        function applyFilters() {
            const activeFilters = getFilterValues();
            const logic = document.getElementById('filterLogic').value;
            
            if (activeFilters.length === 0) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(row => {
                    const matches = activeFilters.map(filter => matchFilter(row, filter));
                    return logic === 'AND' ? matches.every(m => m) : matches.some(m => m);
                });
            }
            
            renderTable();
            updateFilterStats();
        }

        function matchFilter(row, filter) {
            const value = filter.value.toLowerCase();
            const isWildcard = value.includes('%%');
            
            if (filter.column === '') {
                // Global search
                return Object.values(row).some(cellValue => {
                    const cell = String(cellValue || '').toLowerCase();
                    return isWildcard ? matchWildcard(cell, value) : cell.includes(value);
                });
            } else {
                // Column-specific search
                const cell = String(row[filter.column] || '').toLowerCase();
                return isWildcard ? matchWildcard(cell, value) : cell.includes(value);
            }
        }

        function matchWildcard(text, pattern) {
            const regex = new RegExp('^' + pattern.split('%%').map(escapeRegex).join('.*') + '$');
            return regex.test(text);
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function clearFilters() {
            initializeFilters();
            filteredData = [...allData];
            renderTable();
            updateFilterStats();
        }

        function updateFilterStats() {
            const stats = document.getElementById('filterStats');
            stats.innerHTML = `
                <span class="font-semibold">Total:</span> ${allData.length.toLocaleString('fr-FR')} lignes | 
                <span class="font-semibold">Filtr√©es:</span> ${filteredData.length.toLocaleString('fr-FR')} lignes | 
                <span class="font-semibold">Affich√©es:</span> ${Math.min(filteredData.length, MAX_DISPLAY_ROWS).toLocaleString('fr-FR')} lignes
            `;
        }

        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            // Render headers with drag & drop
            thead.innerHTML = `<tr class="select-none">
                ${columnOrder.map(h => `<th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase tracking-wider cursor-move bg-slate-50" data-column="${h}">${h}</th>`).join('')}
            </tr>`;
            
            // Initialize Sortable for drag & drop
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = Sortable.create(thead.querySelector('tr'), {
                animation: 150,
                onEnd: (evt) => {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    const [moved] = columnOrder.splice(oldIndex, 1);
                    columnOrder.splice(newIndex, 0, moved);
                    renderTableBody();
                }
            });
            
            renderTableBody();
        }

        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            const displayData = filteredData.slice(0, MAX_DISPLAY_ROWS);
            
            tbody.innerHTML = displayData.map(row => `
                <tr class="hover:bg-slate-50 transition">
                    ${columnOrder.map(h => `<td class="px-4 py-3 text-sm text-slate-700 whitespace-nowrap">${escapeHtml(row[h] || '')}</td>`).join('')}
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportCSV() {
            const orderedData = filteredData.map(row => {
                const ordered = {};
                columnOrder.forEach(col => ordered[col] = row[col]);
                return ordered;
            });
            
            const csv = Papa.unparse(orderedData);
            downloadFile(csv, 'export.csv', 'text/csv');
        }

        function exportXLSX() {
            const orderedData = filteredData.map(row => {
                const ordered = {};
                columnOrder.forEach(col => ordered[col] = row[col];
                return ordered;
            });
            
            const ws = XLSX.utils.json_to_sheet(orderedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Export');
            XLSX.writeFile(wb, 'export.xlsx');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>